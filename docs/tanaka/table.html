<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">

  <script
  src="//code.jquery.com/jquery-3.3.1.min.js"
  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
  crossorigin="anonymous"></script>

  <title>『捃拾帖』デジタル展示</title>

  <script src="./assets/js/main.js"></script>


  <script>asset('./');</script>

  <style>
  div.dataTables_length {
    padding-left: 2em;
  }
  div.dataTables_length,
  div.dataTables_filter {
    padding-top: 0.55em;
  }
  .table {
    padding-top: 2em;
  }
  .bottom {
    padding-top: 2em;
  }
</style>

</head>
<body>

  <script>header('./');</script>

  <div class="container py-2 my-5">

    <div class="table-responsive my-5">
      <table class="table table-hover" id="table">
        <thead id="thead">
          <tr>
            <th></th>
            <th></th>
            <th>タイトル</th>
            <th>目録番号</th>
            <th>西暦</th>
            <th>地名</th>
            <th>版<!--種類--></th>
            <th>形態<!--分類--></th>
            <th>内容<!--分類--></th>
            <th></th>
          </tr>
        </thead>
        <tbody id="resourceListBody">
        </tbody>
      </table>
    </div>

    <div class="text-center" id="loading">
      <img src="https://img.buzzfeed.com/buzzfeed-static/static/enhanced/web05/2012/4/24/16/anigif_enhanced-buzz-10731-1335299292-14.gif" class="img-fluid"/>
    </div>


  </div>

  <script>footer('./');</script>


  <script>
  jQuery(document).ready(function() {

    var arg  = new Object;
    url = location.search.substring(1).split('&');

    for(i=0; url[i]; i++) {
      var k = url[i].split('=');
      arg[k[0]] = decodeURIComponent(k[1]);
    }

    var q = arg["q"] != null ? arg["q"] : "";
    $("#q").val(q);

    var locationUri = arg["locationUri"] != null ? arg["locationUri"] : "";

    var year = arg["year"] != null ? arg["year"] : "";

    var query = " SELECT distinct * ";
    query += " where { ";
    query += " ?s dcterms:title ?title . ";
    query += " ?s dcterms:spatial ?location. ";

    if(locationUri != ""){
      query += " ?s dcterms:spatial <"+locationUri+"> . ";
    }
    if(year != ""){
      query += " ?s dcterms:date '"+year+"' . ";
    }

    query += " ?s dcterms:tableOfContents ?toc . ";
    query += " ?s dcterms:identifier ?id . ";

    query += " optional { ?s dcterms:date ?date . } ";
    query += " optional { ?s dcterms:subject ?subject . } ";
    query += " optional { ?s dcterms:type ?type . } ";
    query += " optional { ?s dcterms:spatial ?spatial . } ";
    query += " optional { ?s dcterms:extent ?extent . } ";

    query += " optional { ?s foaf:thumbnail ?thumb . } ";
    query += " } ";

    var array = new Array();

    $.ajax({
      url:'https://dydra.com/ut-digital-archives/tanaka/sparql',
      type:'POST',
      data:{
        query : query,
        format : "json"
      }
    })
    // Ajaxリクエストが成功した時発動
    .done( (data) => {
      var result = data.results.bindings;

      var dataSet = []

      arr = ["date", "spatial", "type", "extent", "subject"]

      for (var i = 0; i < result.length; i++) {
        var obj = result[i];

        var row = []
        dataSet.push(row)
        row.push("")

        var img_text = ""
        var img = $("<img class='img-fluid z-depth-1' height='90px'>")
        if(obj.thumb){
          img.attr("src", obj.thumb.value.replace("/,300/", "/,90/"))
        }　else {
          img.attr("src", "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQIQd_xAOzY_r1Ks1qviqM5J_R3pJK7nDUcCFqWZnzdrM1physC1g")
        }
        row.push(img.prop('outerHTML'))


        var a = $("<span>")
        //a.attr("href", "detail.html?curation="+obj.s.value.replace("#", "&pos="))
        //a.attr("target", "_blank")
        a.append(obj.title.value)
        row.push(a.prop('outerHTML'))

        //----------

        var div = $("<div>")

        var span = $("<span style='display : none;'>")
        div.append(span)
        span.append(obj.toc.value)
        div.append(obj.id.value)
        row.push(div.prop("outerHTML"))

        //-----------

        for(var j = 0; j < arr.length; j++){
          e = arr[j]
          text = ""
          if(obj[e]){
            text = obj[e].value
          }
          if(e == "spatial"){
            text = text.replace("http://ja.dbpedia.org/resource/", "")
          }
          row.push(text)
        }

        //-----------

        if(obj.s.value.indexOf("http://example.org") == -1){
          var a = $("<a>")
          a.attr("href", "http://codh.rois.ac.jp/software/iiif-curation-viewer/demo/?curation="+obj.s.value.replace("#", "&pos="))
          a.attr("target", "_blank")
          var img = $("<img>")
          a.append(img)
          img.attr("src", "http://codh.rois.ac.jp/icp/favicons/icp-logo-32x32.png")
          row.push(a.prop('outerHTML'))
        } else {
          row.push("")
        }

      }

      // Setup - add a text input to each footer cell
      $('#table thead th').each( function () {
        var title = $(this).text();
        $(this).html( title+' <input type="text" class="form-control"/>' );
      } );

      // DataTable
      var table = $('#table').DataTable({
        data: dataSet,
        "dom": '<"top"iflp<"clear">>rt<"bottom"iflp<"clear">>',
        "iDisplayLength" : 100,
        "order" : [ [ 3, "asc" ] ],
        "bAutoWidth": false,
        "columnDefs": [
          { "width": "5%", "targets": 0 },
          { "width": "10%", "targets": 1 },
          { "width": "30%", "targets": 2 },
          { "width": "15%", "targets": 3 },
          { "width": "5%", "targets": 4 },
          { "width": "5%", "targets": 5 },
          { "width": "5%", "targets": 6 },
          { "width": "5%", "targets": 7 },
          { "width": "15%", "targets": 8 },
          { "width": "5%", "targets": 9 }
        ],
      });

      // Apply the search
      table.columns().every( function () {
        var that = this;

        $( 'input', this.header() ).on( 'keyup change', function () {
          if ( that.search() !== this.value ) {
            that
            .search( this.value )
            .draw();
          }
        } );
      } );

      table.on('order.dt search.dt', function() {
        table.column(0, {
          search : 'applied',
          order : 'applied'
        }).nodes().each(function(cell, i) {
          cell.innerHTML = i + 1;
        });
      }).draw();


    })
    // Ajaxリクエストが失敗した時発動
    .fail( (data) => {
      alert(data.statusText);
    })
    // Ajaxリクエストが成功・失敗どちらでも発動
    .always( (data) => {
      $("#loading").empty()
    });
  })

  </script>
</body>
</html>
